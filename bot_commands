import discord
import asyncio
import os
import logging

logger = logging.getLogger(__name__)



# -----------------------------
# Fun√ß√£o utilit√°ria: tocar alarme
# -----------------------------
async def play_alarm(ctx):
    """
    Toca alarm.mp3 se existir e o bot estiver em canal de voz.
    Caso contr√°rio, usa fallback de mensagem no canal.
    Observa√ß√£o: requer FFmpeg + PyNaCl para tocar √°udio com sucesso.
    """
    vc = ctx.voice_client
    alarm_file = "alarm.mp3"

    #se estiver conectado ao canal de voz e houver o arquivo, tenta tocar
    if vc is not None and vc.is_connected() and os.path.exists(alarm_file):
        try:
            if vc.is_playing():
                vc.stop()
            source = discord.FFmpegPCMAudio(alarm_file)
            vc.play(source)
            logger.info("Tocando alarm.mp3 no canal de voz.")
            #espera terminar de tocar
            while vc.is_playing():
                await asyncio.sleep(0.5)
            return
        except Exception as e:
            logger.exception("Erro ao tocar alarm.mp3: %s", e)
            #continua para fallback

    #fallback simples: enviar mensagem no canal (mais confi√°vel)
    try:
        await ctx.send("@here ‚è∞ **Alarme!**")
    except Exception as e:
        logger.warning("N√£o foi poss√≠vel enviar mensagem de alarme no canal: %s", e)

    #fallback: enviar mensagem e mencionar canal
    try:
        await ctx.send("@here ‚è∞ **Alarme!**")
    except Exception:
        logger.warning("N√£o foi poss√≠vel enviar mensagem de alarme no canal.")



# -----------------------------
# Fun√ß√£o utilit√°ria: mutar/desmutar membros no canal de voz
# -----------------------------
async def set_mute_for_channel(channel: discord.VoiceChannel, mute: bool, reason: str = None):
    """
    Tenta setar server mute/unmute para todos os membros do channel (exceto bots).
    Verifica se o bot tem permiss√£o antes de tentar.
    """
    #checa permiss√£o do bot no guild
    me = channel.guild.me
    if not me.guild_permissions.mute_members:
        logger.warning("Bot N√ÉO possui permiss√£o 'mute_members' neste servidor; n√£o ser√° poss√≠vel mutar usu√°rios.")
        return

    for member in channel.members:
        if member.bot:
            continue
        try:
            #server mute (edit) ‚Äî requer permiss√£o de Mute Members
            await member.edit(mute=mute, reason=reason)
        except discord.Forbidden:
            logger.warning("Sem permiss√£o para alterar mute de %s", member)
        except Exception as e:
            logger.exception("Erro ao alterar mute de %s: %s", member, e)



# -----------------------------
#  Loop principal do Pomodoro
# -----------------------------
async def pomodoro_loop(ctx, work_minutes: int, break_minutes: int, stop_event: asyncio.Event):
    """
    Loop infinito: work -> alarm -> break -> alarm -> repeat
    stop_event √© verificado para interromper o loop.
    """
    author = ctx.author
    channel = None

    #tenta determinar o canal de voz do autor (se n√£o encontrar, erro)
    if author.voice and author.voice.channel:
        channel = author.voice.channel
    else:
        await ctx.send("Voc√™ precisa estar em um canal de voz para iniciar o Pomodoro.")
        return

    #garante que o bot esteja no mesmo canal (tenta conectar)
    try:
        if ctx.voice_client is None:
            await channel.connect()
            await ctx.send(f"Conectei ao canal de voz **{channel.name}** para gerenciar mutes do Pomodoro.")
        else:
            #se j√° conectado em outro canal, move para o canal do autor
            if ctx.voice_client.channel.id != channel.id:
                await ctx.voice_client.move_to(channel)
                await ctx.send(f"Movido para o canal **{channel.name}** para iniciar Pomodoro.")
        bot = ctx.bot
        bot.pomodoro_channel_id = channel.id

    except RuntimeError as e:
        #comum quando falta PyNaCl
        logger.exception("Erro ao conectar ao canal de voz (PyNaCl?).")
        await ctx.send("N√£o consigo conectar ao canal de voz: verifique se a biblioteca `PyNaCl` est√° instalada.")
        return
    except discord.Forbidden:
        logger.exception("Sem permiss√£o para conectar ao canal de voz.")
        await ctx.send("N√£o tenho permiss√£o para conectar ao canal de voz.")
        return
    except Exception as e:
        logger.exception("Erro ao conectar/mover para canal de voz: %s", e)
        await ctx.send(f"Erro ao conectar ao canal de voz: {e}")
        return

    #converte minutos para segundos
    work_seconds = max(1, int(work_minutes)) * 60
    break_seconds = max(1, int(break_minutes)) * 60

    logger.info("Iniciando loop Pomodoro: trabalho %d min, pausa %d min", work_minutes, break_minutes)

    cycle = 1
    try:
        while not stop_event.is_set():
            #--- POMODORO (trabalho) ---
            bot = ctx.bot
            bot.pomodoro_phase = "work"
            await ctx.send(f"\nüöÄ **Pomodoro {cycle}**: focar por **{work_minutes}** minutos. Mutando usu√°rios...")
            #recaptura canal (pode ter mudado)
            voice_chan = ctx.guild.get_channel(bot.pomodoro_channel_id)
            if voice_chan:
                await set_mute_for_channel(voice_chan, True, reason="In√≠cio do Pomodoro")
            else:
                logger.warning("Nenhum canal de voz encontrado para mutar.")

            #espera o tempo de trabalho verificando stop_event
            for _ in range(work_seconds):
                if stop_event.is_set():
                    break
                await asyncio.sleep(1)
            if stop_event.is_set():
                break

            #alarme no fim do pomodoro
            await play_alarm(ctx)

            # --- PAUSA (break) ---
            bot.pomodoro_phase = "break"
            await ctx.send(f"\n‚òï **Pausa**: relaxe por **{break_minutes}** minutos. Desmutando usu√°rios...")
            if voice_chan:
                await set_mute_for_channel(voice_chan, False, reason="Pausa do Pomodoro")

            for _ in range(break_seconds):
                if stop_event.is_set():
                    break
                await asyncio.sleep(1)
            if stop_event.is_set():
                break

            #alarme no fim da pausa
            await play_alarm(ctx)

            cycle += 1

    except asyncio.CancelledError:
        logger.info("Pomodoro task cancelada.")
    except Exception as e:
        logger.exception("Erro no loop do Pomodoro: %s", e)
        await ctx.send(f"Ocorreu um erro no loop do Pomodoro: {e}")
    finally:
        #tenta desmutar ao sair pra garantir que ningu√©m fique preso mutado
        bot.pomodoro_phase = None
        try:
            vc_channel = ctx.voice_client.channel if ctx.voice_client else channel
            if vc_channel:
                await set_mute_for_channel(vc_channel, False, reason="Pomodoro finalizado")
        except Exception:
            logger.exception("Erro ao desmutar membros no final.")
        logger.info("Loop Pomodoro finalizado.")
